<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スクールチャイム管理システム</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (ライブラリ本体を先にロード) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind CSS 設定: ダークモードを 'class' に設定 (tailwindが定義された後に実行) -->
    <script>
        tailwind.config = {
            darkMode: 'class', 
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* bodyの背景はReactのルート要素でTailwindクラスを使って設定します */
        .digital-clock {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // デフォルトチャイム音源URL
        const DEFAULT_CHIME_URL = "https://github.com/AfterEffects-OK/SchoolChime/raw/refs/heads/main/Japanese_School_Bell02-01(-16dB).mp3";

        // 曜日の定義
        const DAYS_OF_WEEK = [
            { id: 0, label: '日', color: 'text-red-500' },
            { id: 1, label: '月', color: 'text-gray-700 dark:text-gray-300' },
            { id: 2, label: '火', color: 'text-gray-700 dark:text-gray-300' },
            { id: 3, label: '水', color: 'text-gray-700 dark:text-gray-300' },
            { id: 4, label: '木', color: 'text-gray-700 dark:text-gray-300' },
            { id: 5, label: '金', color: 'text-gray-700 dark:text-gray-300' },
            { id: 6, label: '土', color: 'text-blue-500' },
        ];
        
        // アイコンコンポーネント
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        // 音声ファイルアップロード用
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconMusic = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconPause = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
        const IconBell = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18.83 14.83a4 4 0 0 0 .58-4.32c-.3-.88-1-1.68-1.78-2.31L12 2l-5.6 5.6c-.78.63-1.48 1.43-1.78 2.31a4 4 0 0 0 .58 4.32"/><path d="M10 20h4"/><path d="M12 2v20"/></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const IconMoon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
        const IconVolume2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        
        // 【再修正】インポート用アイコン（ダウンロード）
        const IconImport = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        
        // 【再修正】エクスポート用アイコン（ファイルからアップロード）
        const IconExport = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899V20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5.1"/><polyline points="10 10 12 8 14 10"/><line x1="12" y1="20" x2="12" y2="8"/></svg>;


        // アナログ時計コンポーネント
        const AnalogClock = ({ time }) => {
            const seconds = time.getSeconds();
            const minutes = time.getMinutes();
            const hours = time.getHours();

            const secondAngle = seconds * 6;
            const minuteAngle = minutes * 6 + seconds * 0.1;
            const hourAngle = (hours % 12) * 30 + minutes * 0.5;

            return (
                <div className="relative w-48 h-48 mx-auto mb-4">
                    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
                        {/* 文字盤背景: ダークモード対応 */}
                        <circle cx="50" cy="50" r="48" 
                            className="fill-white stroke-gray-200 dark:fill-gray-700 dark:stroke-gray-600" 
                            strokeWidth="2" />
                        
                        {/* 目盛り (分): ダークモード対応 */}
                        {[...Array(60)].map((_, i) => (
                            <line
                                key={i}
                                x1="50" y1="6"
                                x2="50" y2={i % 5 === 0 ? "12" : "8"}
                                className={i % 5 === 0 ? "stroke-gray-700 dark:stroke-gray-300" : "stroke-gray-300 dark:stroke-gray-500"}
                                strokeWidth={i % 5 === 0 ? "2" : "1"}
                                transform={`rotate(${i * 6} 50 50)`}
                            />
                        ))}

                        {/* 時針: ダークモード対応 */}
                        <line
                            x1="50" y1="50"
                            x2="50" y2="25"
                            className="stroke-gray-800 dark:stroke-gray-300"
                            strokeWidth="3"
                            strokeLinecap="round"
                            transform={`rotate(${hourAngle} 50 50)`}
                        />

                        {/* 分針: ダークモード対応 */}
                        <line
                            x1="50" y1="50"
                            x2="50" y2="15"
                            className="stroke-gray-600 dark:stroke-gray-400"
                            strokeWidth="2"
                            strokeLinecap="round"
                            transform={`rotate(${minuteAngle} 50 50)`}
                        />

                        {/* 秒針 */}
                        <line
                            x1="50" y1="50"
                            x2="50" y2="10"
                            className="stroke-red-500"
                            strokeWidth="1"
                            strokeLinecap="round"
                            transform={`rotate(${secondAngle} 50 50)`}
                        />
                        
                        {/* 中心点 */}
                        <circle cx="50" cy="50" r="2" fill="#ef4444" />
                    </svg>
                </div>
            );
        };
        
        // ステータスパネルコンポーネント
        const StatusPanel = ({ isPlaying, audioSources, nextChimeData }) => (
            <div className="space-y-4">
                <h3 className="text-xl font-extrabold text-indigo-700 dark:text-indigo-400 border-b-2 border-indigo-100 dark:border-indigo-900 pb-1">システムステータス</h3>

                {/* 再生ステータス */}
                <div className="flex items-center space-x-3 p-3 rounded-lg border dark:border-gray-700 shadow-sm">
                    <div className={`p-2 rounded-full ${isPlaying ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300 animate-pulse' : 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300'}`}>
                        {isPlaying ? <IconPlay /> : <IconCheck />}
                    </div>
                    <div>
                        <p className="text-sm font-semibold text-gray-500 dark:text-gray-400">現在の状態</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-gray-100">{isPlaying ? 'チャイム再生中...' : '待機中'}</p>
                    </div>
                </div>

                {/* 音源ステータス */}
                <div className="flex items-center space-x-3 p-3 rounded-lg border dark:border-gray-700 shadow-sm">
                    <div className={`p-2 rounded-full bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300`}>
                        <IconMusic />
                    </div>
                    <div>
                        <p className="text-sm font-semibold text-gray-500 dark:text-gray-400">音源ファイル</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-gray-100">
                            {/* 
                                次のチャイムに紐づく音源名を表示。
                                なければ、登録されている音源の数を表示。
                            */}
                            {nextChimeData && audioSources.find(a => a.id === nextChimeData.schedule.audioId) ? audioSources.find(a => a.id === nextChimeData.schedule.audioId).name : `${audioSources.length} 音源登録済み`}
                        </p>
                    </div>
                </div>

                {/* 次のチャイム */}
                <div className="bg-indigo-50 dark:bg-indigo-950 border-2 border-indigo-200 dark:border-indigo-800 p-4 rounded-lg shadow-inner">
                    <div className="flex items-center space-x-2 text-indigo-700 dark:text-indigo-400 mb-2">
                        <IconBell />
                        <h4 className="text-sm font-extrabold uppercase">次のチャイム (NEXT CHIME)</h4>
                    </div>
                    {nextChimeData ? (
                        <div className="flex justify-between items-center">
                            <p className="text-3xl font-mono font-bold text-indigo-800 dark:text-indigo-200">{nextChimeData.schedule.time}</p>
                            <div className="text-right">
                                <p className="text-sm font-semibold text-indigo-600 dark:text-indigo-400">{nextChimeData.dayLabel}</p>
                                <p className="text-lg font-bold text-gray-800 dark:text-gray-100">{nextChimeData.schedule.name}</p>
                            </div>
                        </div>
                    ) : (
                        <p className="text-gray-500 dark:text-gray-400 text-sm">有効なスケジュールがありません</p>
                    )}
                </div>
            </div>
        );


        // メインコンポーネント
        const App = () => {
            // ステート管理
            const [currentTime, setCurrentTime] = useState(new Date());
            // 音源リストを管理。デフォルト音源を初期値として設定
            const [audioSources, setAudioSources] = useState([
                { id: 'default', name: 'デフォルトチャイム音源', url: DEFAULT_CHIME_URL }
            ]);
            const [schedules, setSchedules] = useState([]);
            const [isPlaying, setIsPlaying] = useState(false);
            const [lastPlayedTime, setLastPlayedTime] = useState(null); // 重複再生防止用
            
            // 編集モーダル管理
            const [editingSchedule, setEditingSchedule] = useState(null); // 編集対象のスケジュールオブジェクト

            // 新規スケジュール入力用
            const [newName, setNewName] = useState('');
            const [newTime, setNewTime] = useState('08:30');
            const [newDays, setNewDays] = useState([1, 2, 3, 4, 5]); // デフォルト月〜金
            const [newAudioId, setNewAudioId] = useState('default'); // 新規スケジュール用の音源ID
            const [newScheduleType, setNewScheduleType] = useState('weekly'); // 'weekly' or 'date'
            const [newSpecificDate, setNewSpecificDate] = useState(new Date().toISOString().slice(0, 10)); // YYYY-MM-DD
            const [newVolume, setNewVolume] = useState(1); // 新規スケジュール用の音量

            // 個別再生用のステート
            const [currentlyPlayingId, setCurrentlyPlayingId] = useState(null); // 再生中の音源ID
            const [audioDurations, setAudioDurations] = useState({}); // { id: duration }
            const [audioCurrentTimes, setAudioCurrentTimes] = useState({}); // { id: currentTime }

            const audioRef = useRef(null);
            const importInputRef = useRef(null); // インポート用ファイル入力参照
            const fileInputRef = useRef(null); // 音源アップロード用
            const importIdCounter = useRef(0); // インポート用の一意IDカウンター
            
            // ダークモード状態の初期化と永続化
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const savedMode = localStorage.getItem('schoolChimeDarkMode');
                if (savedMode !== null) return JSON.parse(savedMode);
                // システム設定の検出 (初回のみ)
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            
            const toggleDarkMode = () => {
                setIsDarkMode(prev => !prev);
            };

            // ダークモード設定を<html>タグに適用し、localStorageに保存
            useEffect(() => {
                const html = document.documentElement;
                if (isDarkMode) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                localStorage.setItem('schoolChimeDarkMode', JSON.stringify(isDarkMode));
            }, [isDarkMode]);


            // ローカルストレージからスケジュールを読み込み
            useEffect(() => {
                const savedSchedules = localStorage.getItem('schoolChimeSchedules');
                if (savedSchedules) {
                    try {
                        // スケジュールはリロード後も永続化されます。
                        setSchedules(JSON.parse(savedSchedules));
                    } catch (e) {
                        console.error("保存されたスケジュールの読み込みに失敗しました", e);
                    }
                }
            }, []);

            // スケジュール変更時に保存
            useEffect(() => {
                // スケジュールが変更されるたびにローカルストレージに保存します。
                localStorage.setItem('schoolChimeSchedules', JSON.stringify(schedules));
            }, [schedules]);

            // 時計の更新とアラームチェック
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    setCurrentTime(now);
                    checkAlarm(now);
                }, 1000);

                return () => clearInterval(timer);
            }, [schedules, lastPlayedTime]);

            // アラームチェックロジック
            const checkAlarm = (now) => {
                // 音声ファイルがセットされていない場合は何もしない (audioSrcはデフォルトでセットされているため、ここではaudioRefの準備のみチェック)
                if (!audioRef.current) return;

                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentSecond = now.getSeconds();
                const currentDay = now.getDay();

                // HH:mm 形式の文字列を作成
                const timeString = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`;
                
                // 重複再生防止（同じ分内での連打防止、0秒付近のみでトリガー）
                if (currentSecond > 2) return; 
                
                // 最後に再生した時間が現在と同じ分ならスキップ（1分間に1回だけ鳴らす）
                if (lastPlayedTime === timeString) return;

                // スケジュールと照合
                const activeSchedule = schedules.find(schedule => {
                    if (!schedule.enabled || schedule.time !== timeString) return false;

                    const type = schedule.scheduleType || 'weekly'; // 下位互換性

                    if (type === 'weekly') {
                        return schedule.days.includes(currentDay);
                    }
                    
                    if (type === 'date') {
                        const scheduleDate = schedule.specificDate; // YYYY-MM-DD
                        const todayDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                        return scheduleDate === todayDate;
                    }
                    return false;
                });

                if (activeSchedule) {
                    playChime(activeSchedule);
                    setLastPlayedTime(timeString);
                }
            };

            // 次のチャイムを計算するロジック
            const getNextChime = (now) => {
                const nowTimestamp = now.getTime();
                let soonestTimestamp = Infinity;
                let soonestChime = null;
                let soonestDayLabel = '';

                schedules.filter(s => s.enabled).forEach(schedule => {
                    const type = schedule.scheduleType || 'weekly';
                    const [hour, minute] = schedule.time.split(':').map(Number);

                    if (type === 'date') {
                        const scheduleDate = new Date(`${schedule.specificDate}T${schedule.time}:00`);
                        const scheduleTimestamp = scheduleDate.getTime();
                        if (scheduleTimestamp > nowTimestamp && scheduleTimestamp < soonestTimestamp) {
                            soonestTimestamp = scheduleTimestamp;
                            soonestChime = schedule;
                            soonestDayLabel = schedule.specificDate.replace(/-/g, '/');
                        }
                    } else { // weekly
                        // 今から1週間先までチェック
                        for (let i = 0; i < 8; i++) {
                            const checkDate = new Date(now);
                            checkDate.setDate(now.getDate() + i);
                            const checkDay = checkDate.getDay();

                            if (schedule.days.includes(checkDay)) {
                                checkDate.setHours(hour, minute, 0, 0);
                                const scheduleTimestamp = checkDate.getTime();

                                if (scheduleTimestamp > nowTimestamp && scheduleTimestamp < soonestTimestamp) {
                                    soonestTimestamp = scheduleTimestamp;
                                    soonestChime = schedule;
                                    if (i === 0) soonestDayLabel = '今日';
                                    else if (i === 1) soonestDayLabel = '明日';
                                    else soonestDayLabel = DAYS_OF_WEEK.find(d => d.id === checkDay).label + '曜日';
                                    // この曜日で見つかったので、このスケジュールについてはこれ以上未来を探す必要はない
                                    break; 
                                }
                            }
                        }
                    }
                });

                return soonestChime ? { schedule: soonestChime, dayLabel: soonestDayLabel } : null;
            };

            // チャイム再生
            const playChime = (schedule) => {
                const audioIdToPlay = schedule.audioId || 'default';
                const sourceToPlay = audioSources.find(s => s.id === audioIdToPlay) || audioSources[0];
                
                if (audioRef.current && sourceToPlay) {
                    console.log(`チャイム再生: ${schedule.name} (${sourceToPlay.name})`);
                    // スケジュールに設定された音量を適用（未設定なら100%）
                    audioRef.current.volume = schedule.volume ?? 1;
                    // 再生ソースを動的に設定
                    audioRef.current.src = sourceToPlay.url;
                    audioRef.current.currentTime = 0;
                    audioRef.current.play()
                        // カスタムモーダルを使うべきだが、今回はalertで代用
                        .then(() => setIsPlaying(true))
                        .catch(err => alert(`再生エラー: ブラウザの自動再生ポリシーによりブロックされた可能性があります。一度画面をクリックしてください。\n(${err})`));
                } else {
                    alert(`音源が見つかりません: ${schedule.name} (ID: ${audioIdToPlay})`);
                }
            };

            // 音声アップロード処理
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const newSource = {
                        id: `custom-${Date.now()}`,
                        name: file.name,
                        url: url
                    };
                    setAudioSources(prev => [...prev, newSource]);
                }
                // 同じファイルを連続で選択できるようにリセット
                e.target.value = null;
            };
            
            // 音源削除
            const deleteAudioSource = (idToDelete) => {
                const sourceToDelete = audioSources.find(s => s.id === idToDelete);
                if (sourceToDelete && sourceToDelete.url.startsWith('blob:')) URL.revokeObjectURL(sourceToDelete.url);
                setAudioSources(prev => prev.filter(s => s.id !== idToDelete));
            };

            // 個別再生/一時停止のトグル
            const toggleAudioPlayback = (source) => {
                if (currentlyPlayingId === source.id) {
                    // 再生中なので一時停止
                    audioRef.current.pause();
                    setCurrentlyPlayingId(null);
                } else {
                    // 別の音源を再生
                    setCurrentlyPlayingId(source.id);
                    audioRef.current.src = source.url;
                    audioRef.current.play().catch(e => console.error("Playback failed:", e));
                }
            };

            // audio要素のイベントハンドラ
            const onAudioPlay = () => {
                setIsPlaying(true);
            };
            const onAudioPauseOrEnd = () => {
                setIsPlaying(false);
                setCurrentlyPlayingId(null);
            };
            const onAudioTimeUpdate = () => {
                if (!currentlyPlayingId) return;
                setAudioCurrentTimes(prev => ({
                    ...prev,
                    [currentlyPlayingId]: audioRef.current.currentTime
                }));
            };
            const onAudioLoadedMetadata = (e, sourceId) => {
                // Blob URLの場合はメインのaudio要素でdurationを取得
                if (e.target.src.startsWith('blob:')) {
                    setAudioDurations(prev => ({
                        ...prev,
                        [sourceId]: e.target.duration
                    }));
                }
            };
            
            // デフォルト音源のdurationを取得するためのuseEffect
            useEffect(() => {
                const audio = new Audio(DEFAULT_CHIME_URL);
                const handleMetadata = () => {
                    setAudioDurations(prev => ({ ...prev, 'default': audio.duration }));
                    audio.removeEventListener('loadedmetadata', handleMetadata);
                };
                audio.addEventListener('loadedmetadata', handleMetadata);
                return () => {
                    audio.removeEventListener('loadedmetadata', handleMetadata);
                };
            }, []);

            // 時間を mm:ss 形式にフォーマット
            const formatTime = (seconds) => {
                if (isNaN(seconds) || seconds === Infinity) return '00:00';
                const floorSeconds = Math.floor(seconds);
                const min = Math.floor(floorSeconds / 60);
                const sec = floorSeconds % 60;
                return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            };

            // スケジュール追加
            const addSchedule = () => {
                if (!newName || !newTime) {
                    alert('名前と時間を入力してください'); 
                    return;
                }
                if (newScheduleType === 'weekly' && newDays.length === 0) {
                    alert('曜日を少なくとも1つ選択してください');
                    return;
                }
                if (newScheduleType === 'date' && !newSpecificDate) {
                    alert('日付を指定してください');
                    return;
                }

                const newSchedule = {
                    id: Date.now(),
                    name: newName,
                    time: newTime,
                    enabled: true,
                    audioId: newAudioId,
                    volume: newVolume,
                    scheduleType: newScheduleType,
                    // タイプに応じてデータを格納
                    days: newScheduleType === 'weekly' ? newDays : [],
                    specificDate: newScheduleType === 'date' ? newSpecificDate : '',
                };

                setSchedules([...schedules, newSchedule]);
                
                // 入力フォームをリセット
                setNewName('');
                setNewAudioId('default');
                // タイプと日付はリセットしないでおく
                // setNewScheduleType('weekly');
                // setNewSpecificDate(new Date().toISOString().slice(0, 10));
                setNewVolume(1);
                // 時間と曜日はリセットせず、連続入力をしやすくする
            };

            // スケジュール削除
            const deleteSchedule = (id) => {
                // カスタムモーダルを使うべき
                if (confirm('このスケジュールを削除しますか？')) {
                    setSchedules(schedules.filter(s => s.id !== id));
                }
            };

            // スケジュール有効/無効切り替え
            const toggleSchedule = (id) => {
                setSchedules(schedules.map(s => 
                    s.id === id ? { ...s, enabled: !s.enabled } : s
                ));
            };

            // 曜日選択の切り替え
            const toggleDay = (dayId) => {
                if (newDays.includes(dayId)) {
                    setNewDays(newDays.filter(d => d !== dayId));
                } else {
                    setNewDays([...newDays, dayId].sort());
                }
            };
            
            // 編集モーダルを開く
            const openEditModal = (schedule) => {
                setEditingSchedule({ 
                    ...schedule, 
                    volume: schedule.volume ?? 1,
                    scheduleType: schedule.scheduleType || 'weekly', // 下位互換性
                    specificDate: schedule.specificDate || new Date().toISOString().slice(0, 10),
                });
            };

            // 編集モーダルを閉じる
            const closeEditModal = () => {
                setEditingSchedule(null);
            };

            // スケジュール更新処理
            const updateSchedule = () => {
                if (!editingSchedule) return;
                
                setSchedules(schedules.map(s => 
                    s.id === editingSchedule.id ? editingSchedule : s
                ));
                
                // モーダルを閉じる
                closeEditModal();
            };
            
            // スケジュールエクスポート機能
            const handleExport = () => {
                if (schedules.length === 0) {
                    alert('エクスポートするスケジュールがありません。');
                    return;
                }
                const jsonString = JSON.stringify(schedules, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `school_chime_schedule_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('スケジュールをエクスポートしました。'); 
            };
            
            // スケジュールインポート機能
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedSchedules = JSON.parse(event.target.result);
                        
                        // 基本的な形式のバリデーション
                        if (!Array.isArray(importedSchedules) || importedSchedules.some(s => 
                            !s.id || typeof s.name !== 'string' || typeof s.time !== 'string'
                        )) {
                            alert('インポートされたファイルの形式が正しくありません。期待されるJSON配列形式を確認してください。');
                            return;
                        }

                        // IDの重複を防ぐため、強制的に新しいIDを割り当てる（簡易処理）
                        const schedulesWithNewIds = importedSchedules.map(s => ({
                            ...s,
                            id: Date.now() + (importIdCounter.current++), 
                            enabled: s.enabled ?? true,
                            scheduleType: s.scheduleType || 'weekly',
                            days: s.days || [],
                            specificDate: s.specificDate || '',
                            volume: s.volume ?? 1,
                            // タイムゾーンや日付の調整は複雑なため、time文字列のみを信頼する
                        }));

                        // 現在のスケジュールを置き換える
                        setSchedules(schedulesWithNewIds);
                        alert(`${schedulesWithNewIds.length}件のスケジュールをインポートしました。`);

                    } catch (error) {
                        console.error("スケジュールインポートエラー:", error);
                        alert('ファイルの読み込みまたは解析に失敗しました。ファイルが有効なJSON形式であることを確認してください。');
                    }
                };
                
                reader.onerror = () => {
                    alert('ファイルの読み込みに失敗しました。');
                };

                reader.readAsText(file);
                // ファイル入力をリセットして、同じファイルを再度選択できるようにする
                e.target.value = null; 
            };
            
            // 次のチャイムデータを計算
            const nextChimeData = getNextChime(currentTime);

            // audioRef用の再生ソース。何も再生していないときはデフォルト音源を指しておく
            const initialAudioSrc = (audioSources.find(s => s.id === 'default') || audioSources[0] || {}).url;

            return (
                <div className="min-h-screen pb-10 bg-gray-100 dark:bg-gray-900">
                    {/* ヘッダー */}
                    <header className="bg-indigo-600 text-white p-4 shadow-md">
                        <div className="container mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <IconClock />
                                <h1 className="text-xl font-bold">スクールチャイム管理</h1>
                            </div>
                            
                            {/* ダークモードトグルボタン */}
                            <button 
                                onClick={toggleDarkMode}
                                className="p-2 rounded-full hover:bg-indigo-500 transition-colors"
                                title={isDarkMode ? 'ライトモードに切り替え' : 'ダークモードに切り替え'}
                            >
                                {isDarkMode ? <IconSun /> : <IconMoon />}
                            </button>
                        </div>
                    </header>

                    <div className="container mx-auto p-4 max-w-5xl space-y-6">
                        
                        {/* 時計表示エリア & ステータスパネル */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border-b-4 border-indigo-500">
                            <div className="flex flex-col lg:flex-row lg:divide-x divide-gray-200 dark:divide-gray-700">
                                
                                {/* 左側: 時計本体 */}
                                <div className="lg:w-1/2 p-4 text-center">
                                    <div className="text-gray-500 dark:text-gray-400 mb-2 font-medium">現在時刻</div>
                                    <AnalogClock time={currentTime} />
                                    
                                    <div className="text-6xl md:text-8xl font-mono font-bold text-gray-800 dark:text-gray-100 digital-clock tracking-tight">
                                        {currentTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                                    </div>
                                    <div className="text-xl text-gray-500 dark:text-gray-400 mt-2 font-bold">
                                        {currentTime.toLocaleDateString('ja-JP', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                    </div>
                                </div>

                                {/* 右側: ステータスパネル */}
                                <div className="lg:w-1/2 p-4 pt-8 lg:pt-0">
                                    <StatusPanel 
                                        isPlaying={isPlaying} 
                                        audioSources={audioSources}
                                        nextChimeData={nextChimeData} 
                                    />
                                </div>
                            </div>
                        </div>

                        {/* 音声ファイル設定エリア */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <h2 className="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2 border-b dark:border-gray-700 pb-2">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300"><IconMusic /></span>
                                ステップ 1: チャイム音の設定
                            </h2>
                            
                            <div className="bg-yellow-50 dark:bg-yellow-950 border-l-4 border-yellow-400 dark:border-yellow-600 p-4 mb-4 text-sm text-yellow-800 dark:text-yellow-200">
                                <strong>注意:</strong> スケジュール設定は保存されますが、ブラウザを更新（リロード）すると、セキュリティ上の理由により<strong>アップロードした音声ファイルはリセットされます</strong>。
                            </div>

                            <div className="flex flex-col md:flex-row items-start gap-4">
                                <label className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg cursor-pointer transition shadow-md">
                                    <IconUpload />
                                    <span>音源を追加</span>
                                    <input type="file" accept="audio/*" onChange={handleFileChange} className="hidden" ref={fileInputRef} />
                                </label>
                                
                                <div className="flex-1 w-full space-y-2 overflow-hidden">
                                    {audioSources.map(source => (
                                        <div key={source.id} className="flex items-center gap-2 bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                                            <button onClick={() => toggleAudioPlayback(source)} className="p-2 rounded-full text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900">
                                                {currentlyPlayingId === source.id ? <IconPause /> : <IconPlay />}
                                            </button>
                                            <div className="flex-1 truncate">
                                                <p className="text-sm text-gray-800 dark:text-gray-200 truncate" title={source.name}>
                                                    {source.name}
                                                </p>
                                                <p className="text-xs text-gray-500 dark:text-gray-400 font-mono">
                                                    {formatTime(audioCurrentTimes[source.id] || 0)} / {formatTime(audioDurations[source.id] || 0)}
                                                </p>
                                            </div>
                                            <div className="flex items-center">
                                                {source.id !== 'default' && (
                                                    <button 
                                                        onClick={() => deleteAudioSource(source.id)}
                                                        className="p-2 text-gray-400 hover:text-red-500 rounded-full"
                                                        title="この音源を削除"
                                                    >
                                                        <IconTrash />
                                                    </button>
                                                )}
                                            </div>
                                            {/* 各カスタム音源のdurationを取得するための非表示audio要素 */}
                                            {source.id !== 'default' && (
                                                <audio src={source.url} onLoadedMetadata={(e) => onAudioLoadedMetadata(e, source.id)} className="hidden"></audio>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* 汎用再生用の非表示audio要素 */}
                            <audio
                                ref={audioRef} 
                                onPlay={onAudioPlay}
                                onPause={onAudioPauseOrEnd}
                                onEnded={onAudioPauseOrEnd}
                                onTimeUpdate={onAudioTimeUpdate}
                                className="hidden"
                            />
                        </div>

                        {/* 新規スケジュール登録エリア */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <h2 className="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2 border-b dark:border-gray-700 pb-2">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300"><IconClock /></span>
                                ステップ 2: スケジュール追加
                            </h2>

                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                                <div className="md:col-span-4">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">名前 (例: 朝の会)</label>
                                    <input 
                                        type="text" 
                                        value={newName} 
                                        onChange={(e) => setNewName(e.target.value)}
                                        className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                        placeholder="チャイム名を入力" 
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">時間</label>
                                    <input 
                                        type="time" 
                                        value={newTime} 
                                        onChange={(e) => setNewTime(e.target.value)}
                                        className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono text-base" 
                                    />
                                </div>
                                <div className="md:col-span-3">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">チャイム音</label>
                                    <select 
                                        value={newAudioId} 
                                        onChange={(e) => setNewAudioId(e.target.value)}
                                        className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none text-sm"
                                    >
                                        {audioSources.map(source => (
                                            <option key={source.id} value={source.id}>{source.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="md:col-span-5 w-full">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">タイプ</label>
                                    <div className="flex rounded-md shadow-sm">
                                        <button onClick={() => setNewScheduleType('weekly')} className={`px-4 py-2 text-sm font-medium rounded-l-md flex-1 transition ${newScheduleType === 'weekly' ? 'bg-indigo-600 text-white z-10' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600'}`}>毎週</button>
                                        <button onClick={() => setNewScheduleType('date')} className={`px-4 py-2 text-sm font-medium rounded-r-md flex-1 transition ${newScheduleType === 'date' ? 'bg-indigo-600 text-white z-10' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600 -ml-px'}`}>日付指定</button>
                                    </div>
                                </div>

                                {newScheduleType === 'weekly' ? (
                                    <div className="md:col-span-7 w-full">
                                        <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">曜日</label>
                                        <div className="flex justify-between gap-1">
                                            {DAYS_OF_WEEK.map((day) => (
                                                <button
                                                    key={day.id}
                                                    onClick={() => toggleDay(day.id)}
                                                    className={`
                                                        w-8 h-8 rounded-full text-xs font-bold flex items-center justify-center transition-colors
                                                        ${newDays.includes(day.id) 
                                                            ? 'bg-indigo-600 text-white' 
                                                            : 'bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-400 hover:border-indigo-400 dark:hover:border-indigo-400'}
                                                    `}
                                                    title={`${day.label}曜日`}
                                                >
                                                    {day.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="md:col-span-7 w-full">
                                        <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">日付</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <IconCalendar className="w-4 h-4 text-gray-400" />
                                            </div>
                                            <input 
                                                type="date" 
                                                value={newSpecificDate} 
                                                onChange={(e) => setNewSpecificDate(e.target.value)}
                                                className="w-full pl-10 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono text-base" 
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="md:col-span-5 w-full">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">音量: {Math.round(newVolume * 100)}%</label>
                                    <div className="flex items-center gap-3">
                                        <IconVolume2 className="w-5 h-5 text-gray-500 dark:text-gray-300" />
                                        <input 
                                            type="range" min="0" max="1.5" step="0.01" value={newVolume} onChange={(e) => setNewVolume(parseFloat(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600"
                                        />
                                        <button 
                                            onClick={() => setNewVolume(1)} 
                                            className="text-xs bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 px-2 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition flex-shrink-0"
                                            title="音量を100%に戻す"
                                        >
                                            リセット
                                        </button>
                                    </div>
                                </div>

                                <div className="md:col-span-12 mt-4">
                                    <button 
                                        onClick={addSchedule}
                                        className={`w-full py-2 px-4 rounded-lg font-bold text-white transition bg-green-600 hover:bg-green-700 shadow-md`}
                                    >
                                        + スケジュールに追加
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* スケジュール一覧 */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <h2 className="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2 border-b dark:border-gray-700 pb-2">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300"><IconCalendar /></span>
                                ステップ 3: 登録済みスケジュール
                            </h2>

                            {/* インポート・エクスポートボタン */}
                            <div className="flex gap-2 mb-4">
                                <button onClick={() => importInputRef.current.click()} className="flex-1 flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition shadow-sm text-sm">
                                    <IconImport />
                                    <span>インポート</span>
                                </button>
                                <input type="file" accept=".json" onChange={handleImport} ref={importInputRef} className="hidden" />
                                <button onClick={handleExport} className="flex-1 flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg cursor-pointer transition shadow-sm text-sm">
                                    <IconExport />
                                    <span>エクスポート</span>
                                </button>
                            </div>

                            {schedules.length === 0 ? (
                                <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                    <p>登録されているスケジュールはありません。</p>
                                    <p className="text-sm mt-1">上のフォームから新しいスケジュールを追加してください。</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {schedules.sort((a, b) => a.time.localeCompare(b.time)).map((schedule) => (
                                        <div 
                                            key={schedule.id} 
                                            className={`
                                                p-4 rounded-lg border-l-4 transition-all duration-300
                                                ${schedule.enabled ? 'bg-white dark:bg-gray-800 border-indigo-500 shadow' : 'bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 opacity-60'}
                                            `}
                                        >
                                            <div className="flex flex-col md:flex-row md:items-center md:justify-between">
                                                {/* 左側: スケジュール情報 */}
                                                <div className="flex-1 flex items-start gap-4">
                                                    {/* 有効/無効トグル */}
                                                    <button onClick={() => toggleSchedule(schedule.id)} className={`p-2 rounded-full ${schedule.enabled ? 'text-green-500' : 'text-gray-400'}`} title={schedule.enabled ? '無効にする' : '有効にする'}>
                                                        <div className="w-6 h-6 rounded-full border-2 flex items-center justify-center">
                                                            {schedule.enabled && <IconCheck />}
                                                        </div>
                                                    </button>
                                                    <div>
                                                        <div className="flex items-baseline gap-3">
                                                            <span className="text-2xl font-mono font-bold text-gray-800 dark:text-gray-100">{schedule.time}</span>
                                                            <span className="text-lg font-bold text-indigo-700 dark:text-indigo-300">{schedule.name}</span>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <div className="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
                                                                <IconMusic className="w-3 h-3" />
                                                                <span>{(audioSources.find(s => s.id === schedule.audioId) || {name: '未設定'}).name}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
                                                                <IconVolume2 className="w-3 h-3" />
                                                                <span>{Math.round((schedule.volume ?? 1) * 100)}%</span>
                                                            </div>
                                                        </div>
                                                        {(schedule.scheduleType || 'weekly') === 'weekly' ? (
                                                            <div className="flex gap-1 mt-1">
                                                                {DAYS_OF_WEEK.map(day => (
                                                                    <span 
                                                                        key={day.id} 
                                                                        className={`
                                                                            text-xs px-1.5 py-0.5 rounded
                                                                            ${schedule.days.includes(day.id)
                                                                                ? (day.id === 0 ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300' : day.id === 6 ? 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-100')
                                                                                : 'text-gray-300 dark:text-gray-500'}
                                                                        `}
                                                                    >
                                                                        {day.label}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <div className="flex items-center gap-1 mt-1 text-xs font-semibold text-purple-700 dark:text-purple-300 bg-purple-100 dark:bg-purple-900 px-2 py-1 rounded-full w-fit">
                                                                <IconCalendar className="w-3 h-3" />
                                                                <span>{schedule.specificDate}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* 右側: 操作ボタン */}
                                                <div className="flex items-center gap-2 mt-4 md:mt-0 w-full md:w-auto justify-end">
                                                    <button onClick={() => playChime(schedule)} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-full transition dark:text-indigo-400 dark:hover:bg-indigo-900" title="テスト再生">
                                                        <IconPlay />
                                                    </button>
                                                    <button onClick={() => openEditModal(schedule)} className="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-full transition dark:hover:bg-blue-900 dark:hover:text-blue-300" title="編集">
                                                        <IconEdit />
                                                    </button>
                                                    <button onClick={() => deleteSchedule(schedule.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition dark:hover:bg-red-900 dark:hover:text-red-400" title="削除">
                                                        <IconTrash />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* 編集モーダル */}
                        {editingSchedule && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
                                    <div className="p-4 border-b dark:border-gray-700">
                                        <h3 className="text-lg font-bold text-gray-800 dark:text-gray-100">スケジュールの編集</h3>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        {/* 名前 */}
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">名前</label>
                                            <input type="text" value={editingSchedule.name} onChange={(e) => setEditingSchedule({...editingSchedule, name: e.target.value})} className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" />
                                        </div>
                                        {/* 時間 */}
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">時間</label>
                                            <input type="time" value={editingSchedule.time} onChange={(e) => setEditingSchedule({...editingSchedule, time: e.target.value})} className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded font-mono" />
                                        </div>
                                        {/* チャイム音 */}
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">チャイム音</label>
                                            <select 
                                                value={editingSchedule.audioId || 'default'} 
                                                onChange={(e) => setEditingSchedule({...editingSchedule, audioId: e.target.value})}
                                                className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded"
                                            >
                                                {audioSources.map(source => (
                                                    <option key={source.id} value={source.id}>{source.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        {/* タイプ */}
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">タイプ</label>
                                            <div className="flex rounded-md shadow-sm">
                                                <button onClick={() => setEditingSchedule({...editingSchedule, scheduleType: 'weekly'})} className={`px-4 py-2 text-sm font-medium rounded-l-md flex-1 transition ${editingSchedule.scheduleType === 'weekly' ? 'bg-indigo-600 text-white z-10' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 border border-gray-300 dark:border-gray-600'}`}>
                                                    毎週
                                                </button>
                                                <button onClick={() => setEditingSchedule({...editingSchedule, scheduleType: 'date'})} className={`px-4 py-2 text-sm font-medium rounded-r-md flex-1 transition ${editingSchedule.scheduleType === 'date' ? 'bg-indigo-600 text-white z-10' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 border border-gray-300 dark:border-gray-600 -ml-px'}`}>
                                                    日付指定
                                                </button>
                                            </div>
                                        </div>
                                        {/* 音量 */}
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">音量: {Math.round(editingSchedule.volume * 100)}%</label>
                                            <div className="flex items-center gap-3">
                                                <IconVolume2 className="w-5 h-5 text-gray-500 dark:text-gray-300" />
                                                <input 
                                                    type="range" min="0" max="1.5" step="0.01" 
                                                    value={editingSchedule.volume} 
                                                    onChange={(e) => setEditingSchedule({...editingSchedule, volume: parseFloat(e.target.value)})}
                                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                                />
                                                <button 
                                                    onClick={() => setEditingSchedule({...editingSchedule, volume: 1})} 
                                                    className="text-xs bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 px-2 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition flex-shrink-0"
                                                    title="音量を100%に戻す"
                                                >
                                                    リセット
                                                </button>
                                            </div>
                                        </div>
                                        {/* 曜日 or 日付 */}
                                        {editingSchedule.scheduleType === 'weekly' ? (
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">曜日</label>
                                                <div className="flex justify-between gap-1">
                                                    {DAYS_OF_WEEK.map((day) => (
                                                        <button
                                                            key={day.id}
                                                            onClick={() => {
                                                                const currentDays = editingSchedule.days || [];
                                                                const newDays = currentDays.includes(day.id)
                                                                    ? currentDays.filter(d => d !== day.id)
                                                                    : [...currentDays, day.id].sort();
                                                                setEditingSchedule({...editingSchedule, days: newDays});
                                                            }}
                                                            className={`
                                                                w-10 h-10 rounded-full text-sm font-bold flex items-center justify-center transition-colors
                                                                ${(editingSchedule.days || []).includes(day.id) 
                                                                    ? 'bg-indigo-600 text-white' 
                                                                    : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 hover:border-indigo-400'}
                                                            `}
                                                            title={`${day.label}曜日`}
                                                        >
                                                            {day.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 dark:text-gray-400 mb-1">日付</label>
                                                <div className="relative">
                                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><IconCalendar className="w-4 h-4 text-gray-400" /></div>
                                                    <input 
                                                        type="date" 
                                                        value={editingSchedule.specificDate} 
                                                        onChange={(e) => setEditingSchedule({...editingSchedule, specificDate: e.target.value})}
                                                        className="w-full pl-10 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded font-mono" 
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="p-4 bg-gray-50 dark:bg-gray-700 flex justify-end gap-2 rounded-b-lg">
                                        <button 
                                            onClick={closeEditModal}
                                            className="px-4 py-2 rounded text-gray-700 bg-gray-200 hover:bg-gray-300 dark:text-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 transition"
                                        >
                                            キャンセル
                                        </button>
                                        <button 
                                            onClick={updateSchedule}
                                            className="px-4 py-2 rounded text-white bg-indigo-600 hover:bg-indigo-700 transition"
                                        >
                                            保存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>