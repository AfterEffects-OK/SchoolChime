<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スクールチャイム管理システム</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (ライブラリ本体を先にロード) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind CSS 設定: ダークモードを 'class' に設定 (tailwindが定義された後に実行) -->
    <script>
        tailwind.config = {
            darkMode: 'class', 
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* bodyの背景はReactのルート要素でTailwindクラスを使って設定します */
        .digital-clock {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // デフォルトチャイム音源URL
        const DEFAULT_CHIME_URL = "https://github.com/AfterEffects-OK/SchoolChime/raw/refs/heads/main/Japanese_School_Bell02-01(-16dB).mp3";

        // 曜日の定義
        const DAYS_OF_WEEK = [
            { id: 0, label: '日', color: 'text-red-500' },
            { id: 1, label: '月', color: 'text-gray-700 dark:text-gray-300' },
            { id: 2, label: '火', color: 'text-gray-700 dark:text-gray-300' },
            { id: 3, label: '水', color: 'text-gray-700 dark:text-gray-300' },
            { id: 4, label: '木', color: 'text-gray-700 dark:text-gray-300' },
            { id: 5, label: '金', color: 'text-gray-700 dark:text-gray-300' },
            { id: 6, label: '土', color: 'text-blue-500' },
        ];
        
        // アイコンコンポーネント (ダークモード対応のため、クラスを調整)
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconMusic = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconPause = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
        const IconBell = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18.83 14.83a4 4 0 0 0 .58-4.32c-.3-.88-1-1.68-1.78-2.31L12 2l-5.6 5.6c-.78.63-1.48 1.43-1.78 2.31a4 4 0 0 0 .58 4.32"/><path d="M10 20h4"/><path d="M12 2v20"/></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const IconMoon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;


        // アナログ時計コンポーネント
        const AnalogClock = ({ time }) => {
            const seconds = time.getSeconds();
            const minutes = time.getMinutes();
            const hours = time.getHours();

            const secondAngle = seconds * 6;
            const minuteAngle = minutes * 6 + seconds * 0.1;
            const hourAngle = (hours % 12) * 30 + minutes * 0.5;

            return (
                <div className="relative w-48 h-48 mx-auto mb-4">
                    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
                        {/* 文字盤背景: ダークモード対応 */}
                        <circle cx="50" cy="50" r="48" 
                            fill="white" className="dark:fill-gray-700" 
                            stroke="#e5e7eb" className="dark:stroke-gray-600" 
                            strokeWidth="2" />
                        
                        {/* 目盛り (分): ダークモード対応 */}
                        {[...Array(60)].map((_, i) => (
                            <line
                                key={i}
                                x1="50" y1="6"
                                x2="50" y2={i % 5 === 0 ? "12" : "8"}
                                stroke={i % 5 === 0 ? "#374151" : "#d1d5db"}
                                className={i % 5 === 0 ? "dark:stroke-gray-300" : "dark:stroke-gray-500"}
                                strokeWidth={i % 5 === 0 ? "2" : "1"}
                                transform={`rotate(${i * 6} 50 50)`}
                            />
                        ))}

                        {/* 時針: ダークモード対応 */}
                        <line
                            x1="50" y1="50"
                            x2="50" y2="25"
                            stroke="#1f2937" className="dark:stroke-gray-300"
                            strokeWidth="3"
                            strokeLinecap="round"
                            transform={`rotate(${hourAngle} 50 50)`}
                        />

                        {/* 分針: ダークモード対応 */}
                        <line
                            x1="50" y1="50"
                            x2="50" y2="15"
                            stroke="#4b5563" className="dark:stroke-gray-400"
                            strokeWidth="2"
                            strokeLinecap="round"
                            transform={`rotate(${minuteAngle} 50 50)`}
                        />

                        {/* 秒針 */}
                        <line
                            x1="50" y1="50"
                            x2="50" y2="10"
                            stroke="#ef4444" 
                            strokeWidth="1"
                            strokeLinecap="round"
                            transform={`rotate(${secondAngle} 50 50)`}
                        />
                        
                        {/* 中心点 */}
                        <circle cx="50" cy="50" r="2" fill="#ef4444" />
                    </svg>
                </div>
            );
        };
        
        // ステータスパネルコンポーネント
        const StatusPanel = ({ isPlaying, audioFile, nextChimeData }) => (
            <div className="space-y-4">
                <h3 className="text-xl font-extrabold text-indigo-700 dark:text-indigo-400 border-b-2 border-indigo-100 dark:border-indigo-900 pb-1">システムステータス</h3>

                {/* 再生ステータス */}
                <div className="flex items-center space-x-3 p-3 rounded-lg border dark:border-gray-700 shadow-sm">
                    <div className={`p-2 rounded-full ${isPlaying ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300 animate-pulse' : 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300'}`}>
                        {isPlaying ? <IconPause /> : <IconCheck />}
                    </div>
                    <div>
                        <p className="text-sm font-semibold text-gray-500 dark:text-gray-400">現在の状態</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-gray-100">{isPlaying ? 'チャイム再生中...' : '待機中'}</p>
                    </div>
                </div>

                {/* 音源ステータス */}
                <div className="flex items-center space-x-3 p-3 rounded-lg border dark:border-gray-700 shadow-sm">
                    <div className={`p-2 rounded-full bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300`}>
                        <IconMusic />
                    </div>
                    <div>
                        <p className="text-sm font-semibold text-gray-500 dark:text-gray-400">音源ファイル</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-gray-100">
                            {/* audioFileがセットされていればそのファイル名、そうでなければデフォルト音源名を表示 */}
                            {audioFile ? audioFile.name : 'デフォルトチャイム音源'}
                        </p>
                    </div>
                </div>

                {/* 次のチャイム */}
                <div className="bg-indigo-50 dark:bg-indigo-950 border-2 border-indigo-200 dark:border-indigo-800 p-4 rounded-lg shadow-inner">
                    <div className="flex items-center space-x-2 text-indigo-700 dark:text-indigo-400 mb-2">
                        <IconBell />
                        <h4 className="text-sm font-extrabold uppercase">次のチャイム (NEXT CHIME)</h4>
                    </div>
                    {nextChimeData ? (
                        <div className="flex justify-between items-center">
                            <p className="text-3xl font-mono font-bold text-indigo-800 dark:text-indigo-200">{nextChimeData.schedule.time}</p>
                            <div className="text-right">
                                <p className="text-sm font-semibold text-indigo-600 dark:text-indigo-400">{nextChimeData.dayLabel}</p>
                                <p className="text-lg font-bold text-gray-800 dark:text-gray-100">{nextChimeData.schedule.name}</p>
                            </div>
                        </div>
                    ) : (
                        <p className="text-gray-500 dark:text-gray-400 text-sm">有効なスケジュールがありません</p>
                    )}
                </div>
            </div>
        );


        // メインコンポーネント
        const App = () => {
            // ステート管理
            const [currentTime, setCurrentTime] = useState(new Date());
            // audioFileはアップロードされたファイルオブジェクトを保持 (デフォルト音源の場合はnull)
            const [audioFile, setAudioFile] = useState(null); 
            // audioSrcは再生に使用するURLを保持 (デフォルトURLで初期化)
            const [audioSrc, setAudioSrc] = useState(DEFAULT_CHIME_URL); 
            const [schedules, setSchedules] = useState([]);
            const [isPlaying, setIsPlaying] = useState(false);
            const [lastPlayedTime, setLastPlayedTime] = useState(null); // 重複再生防止用
            
            // 新規スケジュール入力用
            const [newName, setNewName] = useState('');
            const [newTime, setNewTime] = useState('08:30');
            const [newDays, setNewDays] = useState([1, 2, 3, 4, 5]); // デフォルト月〜金

            const audioRef = useRef(null);
            
            // ダークモード状態の初期化と永続化
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const savedMode = localStorage.getItem('schoolChimeDarkMode');
                if (savedMode !== null) return JSON.parse(savedMode);
                // システム設定の検出 (初回のみ)
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            
            const toggleDarkMode = () => {
                setIsDarkMode(prev => !prev);
            };

            // ダークモード設定を<html>タグに適用し、localStorageに保存
            useEffect(() => {
                const html = document.documentElement;
                if (isDarkMode) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                localStorage.setItem('schoolChimeDarkMode', JSON.stringify(isDarkMode));
            }, [isDarkMode]);


            // ローカルストレージからスケジュールを読み込み
            useEffect(() => {
                const savedSchedules = localStorage.getItem('schoolChimeSchedules');
                if (savedSchedules) {
                    try {
                        // スケジュールはリロード後も永続化されます。
                        setSchedules(JSON.parse(savedSchedules));
                    } catch (e) {
                        console.error("保存されたスケジュールの読み込みに失敗しました", e);
                    }
                }
            }, []);

            // スケジュール変更時に保存
            useEffect(() => {
                // スケジュールが変更されるたびにローカルストレージに保存します。
                localStorage.setItem('schoolChimeSchedules', JSON.stringify(schedules));
            }, [schedules]);

            // 時計の更新とアラームチェック
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    setCurrentTime(now);
                    checkAlarm(now);
                }, 1000);

                return () => clearInterval(timer);
            }, [schedules, audioSrc, lastPlayedTime]);

            // アラームチェックロジック
            const checkAlarm = (now) => {
                // 音声ファイルがセットされていない場合は何もしない (audioSrcはデフォルトでセットされているため、ここではaudioRefの準備のみチェック)
                if (!audioRef.current) return;

                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentSecond = now.getSeconds();
                const currentDay = now.getDay();

                // HH:mm 形式の文字列を作成
                const timeString = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`;
                
                // 重複再生防止（同じ分内での連打防止、0秒付近のみでトリガー）
                if (currentSecond > 2) return; 
                
                // 最後に再生した時間が現在と同じ分ならスキップ（1分間に1回だけ鳴らす）
                if (lastPlayedTime === timeString) return;

                // スケジュールと照合
                const activeSchedule = schedules.find(schedule => {
                    return (
                        schedule.enabled &&
                        schedule.time === timeString &&
                        schedule.days.includes(currentDay)
                    );
                });

                if (activeSchedule) {
                    playChime(activeSchedule.name);
                    setLastPlayedTime(timeString);
                }
            };

            // 次のチャイムを計算するロジック
            const getNextChime = (now) => {
                const currentDay = now.getDay();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                let nextChime = null;
                let minDifference = Infinity;
                let nextDayLabel = '';
                
                // 1. 今日の残りのチャイムを探す
                const todayChimes = schedules.filter(s => s.enabled && s.days.includes(currentDay))
                    .sort((a, b) => a.time.localeCompare(b.time));

                for (const schedule of todayChimes) {
                    const [schHour, schMinute] = schedule.time.split(':').map(Number);
                    
                    // スケジュール時刻を分数に変換
                    const scheduleMinutes = schHour * 60 + schMinute;
                    // 現在時刻を分数に変換
                    const currentTotalMinutes = currentHour * 60 + currentMinute;

                    // スケジュール時刻が現在時刻より後か
                    if (scheduleMinutes > currentTotalMinutes) {
                        const difference = scheduleMinutes - currentTotalMinutes;
                        if (difference < minDifference) {
                            minDifference = difference;
                            nextChime = schedule;
                            nextDayLabel = '今日';
                        }
                    }
                }

                // 2. 今日見つからなかった場合、次の日から1週間先まで探す
                if (!nextChime) {
                    for (let d = 1; d <= 7; d++) {
                        const searchDayIndex = (currentDay + d) % 7;
                        
                        const dayChimes = schedules.filter(s => s.enabled && s.days.includes(searchDayIndex))
                            .sort((a, b) => a.time.localeCompare(b.time));

                        if (dayChimes.length > 0) {
                            // その日の最初のチャイムが最も早い次のチャイム
                            nextChime = dayChimes[0];
                            
                            // 日付ラベルを決定
                            if (d === 1) {
                                nextDayLabel = '明日';
                            } else {
                                nextDayLabel = DAYS_OF_WEEK.find(day => day.id === searchDayIndex).label + '曜日';
                            }
                            
                            // 差分は不要だが、ループを抜ける
                            break;
                        }
                    }
                }
                
                return nextChime ? { schedule: nextChime, dayLabel: nextDayLabel } : null;
            };

            // チャイム再生
            const playChime = (scheduleName) => {
                if (audioRef.current && audioSrc) {
                    console.log(`チャイム再生: ${scheduleName} from ${audioSrc}`);
                    audioRef.current.currentTime = 0;
                    audioRef.current.play()
                        // カスタムモーダルを使うべきだが、今回はalertで代用
                        .then(() => setIsPlaying(true))
                        .catch(err => alert(`再生エラー: ブラウザの自動再生ポリシーによりブロックされた可能性があります。一度画面をクリックしてください。\n(${err})`));
                } else {
                    alert('チャイム音源が設定されていません。');
                }
            };

            // 音声アップロード処理
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setAudioFile(file);
                    // アップロードされたファイルのURLを使用
                    const url = URL.createObjectURL(file);
                    setAudioSrc(url);
                } else {
                    // ファイル選択がキャンセルされた場合、デフォルト音源に戻す
                    setAudioFile(null);
                    setAudioSrc(DEFAULT_CHIME_URL);
                }
            };

            // スケジュール追加
            const addSchedule = () => {
                if (!newName || !newTime) {
                    alert('名前と時間を入力してください'); 
                    return;
                }
                if (newDays.length === 0) {
                    alert('曜日を少なくとも1つ選択してください');
                    return;
                }

                const newSchedule = {
                    id: Date.now(),
                    name: newName,
                    time: newTime,
                    days: newDays,
                    enabled: true
                };

                setSchedules([...schedules, newSchedule]);
                setNewName('');
                // 時間と曜日はリセットせず、連続入力をしやすくする
            };

            // スケジュール削除
            const deleteSchedule = (id) => {
                // カスタムモーダルを使うべき
                if (confirm('このスケジュールを削除しますか？')) {
                    setSchedules(schedules.filter(s => s.id !== id));
                }
            };

            // スケジュール有効/無効切り替え
            const toggleSchedule = (id) => {
                setSchedules(schedules.map(s => 
                    s.id === id ? { ...s, enabled: !s.enabled } : s
                ));
            };

            // 曜日選択の切り替え
            const toggleDay = (dayId) => {
                if (newDays.includes(dayId)) {
                    setNewDays(newDays.filter(d => d !== dayId));
                } else {
                    setNewDays([...newDays, dayId].sort());
                }
            };
            
            // 次のチャイムデータを計算
            const nextChimeData = getNextChime(currentTime);


            return (
                <div className="min-h-screen pb-10 bg-gray-100 dark:bg-gray-900">
                    {/* ヘッダー */}
                    <header className="bg-indigo-600 text-white p-4 shadow-md">
                        <div className="container mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <IconClock />
                                <h1 className="text-xl font-bold">スクールチャイム管理</h1>
                            </div>
                            
                            {/* ダークモードトグルボタン */}
                            <button 
                                onClick={toggleDarkMode}
                                className="p-2 rounded-full hover:bg-indigo-500 transition-colors"
                                title={isDarkMode ? 'ライトモードに切り替え' : 'ダークモードに切り替え'}
                            >
                                {isDarkMode ? <IconSun /> : <IconMoon />}
                            </button>
                        </div>
                    </header>

                    <div className="container mx-auto p-4 max-w-5xl space-y-6">
                        
                        {/* 1. 時計表示エリア & ステータスパネル */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border-b-4 border-indigo-500">
                            <div className="flex flex-col lg:flex-row lg:divide-x divide-gray-200 dark:divide-gray-700">
                                
                                {/* 左側: 時計本体 (デジタル・アナログ) */}
                                <div className="lg:w-1/2 p-4 text-center">
                                    <div className="text-gray-500 dark:text-gray-400 mb-2 font-medium">現在時刻</div>
                                    <AnalogClock time={currentTime} />
                                    
                                    <div className="text-6xl md:text-8xl font-mono font-bold text-gray-800 dark:text-gray-100 digital-clock tracking-tight">
                                        {currentTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                                    </div>
                                    <div className="text-xl text-gray-500 dark:text-gray-400 mt-2 font-bold">
                                        {currentTime.toLocaleDateString('ja-JP', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                    </div>
                                </div>

                                {/* 右側: ステータスパネル (次のチャイム、再生状況) */}
                                <div className="lg:w-1/2 p-4 pt-8 lg:pt-0">
                                    <StatusPanel 
                                        isPlaying={isPlaying} 
                                        audioFile={audioFile} // デフォルト音源の場合はnull
                                        nextChimeData={nextChimeData} 
                                    />
                                </div>
                            </div>
                        </div>

                        {/* 2. 音声ファイル設定エリア */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <h2 className="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2 border-b dark:border-gray-700 pb-2">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300"><IconMusic /></span>
                                ステップ 1: チャイム音の設定
                            </h2>
                            
                            {/* デフォルト音源使用中の注意 */}
                            {!audioFile && (
                                <div className="bg-indigo-50 dark:bg-indigo-950 border-l-4 border-indigo-400 dark:border-indigo-600 p-4 mb-4 text-sm text-indigo-800 dark:text-indigo-200">
                                    <strong>デフォルト音源を使用中:</strong> {DEFAULT_CHIME_URL.split('/').pop()}が自動でロードされています。
                                </div>
                            )}

                            {/* アップロード時の注意 */}
                            {audioFile && (
                                <div className="bg-yellow-50 dark:bg-yellow-950 border-l-4 border-yellow-400 dark:border-yellow-600 p-4 mb-4 text-sm text-yellow-800 dark:text-yellow-200">
                                    <strong>注意:</strong> スケジュール設定は保存されますが、ブラウザを更新（リロード）すると、セキュリティ上の理由により<strong>アップロードした音声ファイルはリセットされ、デフォルト音源に戻ります</strong>。
                                </div>
                            )}

                            <div className="flex flex-col md:flex-row items-start md:items-center gap-4">
                                <label className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg cursor-pointer transition">
                                    <IconUpload />
                                    <span>独自の音声ファイルを選択</span>
                                    {/* ユーザーがファイルをアップロードした際、audioFileとaudioSrcが更新されます */}
                                    <input type="file" accept="audio/*" onChange={handleFileChange} className="hidden" />
                                </label>
                                
                                {/* audioSrcが存在すれば、Audioタグを表示 */}
                                {audioSrc && (
                                    <div className="flex-1 w-full md:w-auto">
                                        <div className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                            {audioFile ? `選択中: ${audioFile.name}` : `デフォルト音源を再生`}
                                        </div>
                                        <audio 
                                            ref={audioRef} 
                                            src={audioSrc} 
                                            controls 
                                            className="w-full h-10"
                                            onPlay={() => setIsPlaying(true)}
                                            onPause={() => setIsPlaying(false)}
                                            onEnded={() => setIsPlaying(false)}
                                        />
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 3. 新規スケジュール登録エリア */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                            <h2 className="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2 border-b dark:border-gray-700 pb-2">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300"><IconClock /></span>
                                ステップ 2: スケジュール追加
                            </h2>

                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                                <div className="md:col-span-4">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">名前 (例: 朝の会)</label>
                                    <input 
                                        type="text" 
                                        value={newName} 
                                        onChange={(e) => setNewName(e.target.value)}
                                        className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                        placeholder="チャイム名を入力" 
                                    />
                                </div>
                                <div className="md:col-span-3">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">時間</label>
                                    <input 
                                        type="time" 
                                        value={newTime} 
                                        onChange={(e) => setNewTime(e.target.value)}
                                        className="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono text-lg" 
                                    />
                                </div>
                                <div className="md:col-span-5 w-full">
                                    <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">曜日</label>
                                    <div className="flex justify-between gap-1">
                                        {DAYS_OF_WEEK.map((day) => (
                                            <button
                                                key={day.id}
                                                onClick={() => toggleDay(day.id)}
                                                className={`
                                                    w-8 h-8 rounded-full text-xs font-bold flex items-center justify-center transition-colors
                                                    ${newDays.includes(day.id) 
                                                        ? 'bg-indigo-600 text-white' 
                                                        : 'bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-400 hover:border-indigo-400 dark:hover:border-indigo-400'}
                                                `}
                                                title={`${day.label}曜日`}
                                            >
                                                {day.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="md:col-span-12 mt-2">
                                    <button 
                                        onClick={addSchedule}
                                        // デフォルト音源が設定されているため、無効化の条件を削除
                                        className={`w-full py-2 px-4 rounded-lg font-bold text-white transition bg-green-600 hover:bg-green-700 shadow-sm`}
                                    >
                                        + スケジュールに追加
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 4. スケジュール一覧エリア */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                             <h2 className="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2 border-b dark:border-gray-700 pb-2">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300"><IconClock /></span>
                                登録済みスケジュール
                            </h2>

                            {schedules.length === 0 ? (
                                <div className="text-center py-10 text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-700 rounded-lg border-2 border-dashed border-gray-200 dark:border-gray-600">
                                    まだスケジュールが登録されていません
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {schedules.sort((a, b) => a.time.localeCompare(b.time)).map((schedule) => (
                                        <div 
                                            key={schedule.id} 
                                            className={`
                                                flex flex-col md:flex-row items-center justify-between p-4 rounded-lg border transition-all
                                                ${schedule.enabled 
                                                    ? 'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 shadow-sm' 
                                                    : 'bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 opacity-60'}
                                            `}
                                        >
                                            <div className="flex items-center gap-4 w-full md:w-auto">
                                                {/* ON/OFF Switch */}
                                                <button 
                                                    onClick={() => toggleSchedule(schedule.id)}
                                                    className={`
                                                        relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none
                                                        ${schedule.enabled ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'}
                                                    `}
                                                >
                                                    <span
                                                        className={`
                                                            inline-block h-4 w-4 transform rounded-full bg-white transition-transform
                                                            ${schedule.enabled ? 'translate-x-6' : 'translate-x-1'}
                                                        `}
                                                    />
                                                </button>

                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-2xl font-mono font-bold text-gray-800 dark:text-gray-100">{schedule.time}</span>
                                                        <span className="text-lg font-bold text-indigo-700 dark:text-indigo-300">{schedule.name}</span>
                                                    </div>
                                                    <div className="flex gap-1 mt-1">
                                                        {DAYS_OF_WEEK.map(day => (
                                                            <span 
                                                                key={day.id} 
                                                                className={`
                                                                    text-xs px-1.5 py-0.5 rounded
                                                                    ${schedule.days.includes(day.id)
                                                                        ? (day.id === 0 ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300' : day.id === 6 ? 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-100')
                                                                        : 'text-gray-300 dark:text-gray-500'}
                                                                `}
                                                            >
                                                                {day.label}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="flex items-center gap-2 mt-4 md:mt-0 w-full md:w-auto justify-end">
                                                {/* 手動テスト再生ボタン */}
                                                <button 
                                                    onClick={() => playChime(schedule.name + '(テスト)')}
                                                    className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-full transition dark:text-indigo-400 dark:hover:bg-indigo-900"
                                                    title="テスト再生"
                                                >
                                                    <IconPlay />
                                                </button>
                                                
                                                {/* 削除ボタン */}
                                                <button 
                                                    onClick={() => deleteSchedule(schedule.id)}
                                                    className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition dark:hover:bg-red-900 dark:hover:text-red-300"
                                                    title="削除"
                                                >
                                                    <IconTrash />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
